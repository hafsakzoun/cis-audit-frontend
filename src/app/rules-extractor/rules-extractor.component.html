<div class="main-content">
  <div class="container-fluid">
    <!-- PDF to CSV -->
      <div class="card mt-4">
        <div class="card-header card-header-danger text-center">
          <h4 class="card-title">CIS Benchmark Extractor</h4>
          <p class="card-category">Upload a CIS PDF benchmark and extract rules to CSV format</p>
        </div>
      
        <div class="card-body">
          <div class="text-center mb-5">
            <h2 class="text-danger font-weight-bold">PDF to CSV Tool</h2>
            <p class="text-muted">Automate extraction of security controls from official PDFs.</p>
          </div>

       <div class="row justify-content-center align-items-start mb-4">
      <!-- File Upload Section -->
      <div class="col-md-5">
        <div class="form-group">
             <!-- Label -->
          <label *ngIf="!selectedFile" for="fileUpload" class="bmd-label-floating">Select CIS Benchmark PDF</label>

          <!-- Input -->
          <div *ngIf="!selectedFile">
            <input id="fileUpload" type="file" class="form-control-file"
                   (change)="onFileSelected($event)" accept="application/pdf">
          </div>

               <!-- File Selected Display -->
          <div *ngIf="selectedFile" class="border p-2 rounded bg-light">
            <div class="d-flex align-items-center justify-content-between">
              <span class="text-dark">
                <strong>Selected PDF:</strong> {{ selectedFile?.name }}
              </span>
              <button class="btn btn-outline-secondary btn-icon-only btn-sm rounded-circle" 
                      title="Clear file" 
                      (click)="onFileSelected({ target: { files: [] } })">
                <i class="material-icons">close</i>
              </button>
            </div>
          <!-- ✅ Only show after CSV is extracted -->
          <div class="mt-1 text-muted" *ngIf="extractedEntries.length > 0 && extractedEntries[0].fileName">
            <strong>Generated CSV:</strong> {{ extractedEntries[0].fileName }}
          </div>
        </div>
      </div>
    </div>

        <!-- Buttons Section -->
      <div class="col-md-3 d-flex flex-column align-items-stretch">
        <!-- Extract Button -->
        <button class="btn btn-danger btn-block mb-2" 
                (click)="uploadFile()" 
                [disabled]="!selectedFile">
          <i class="material-icons">cloud_upload</i> Extract CSV
        </button>

        <!-- Download Button -->
          <button class="btn btn-success btn-block"
            (click)="downloadCSV(extractedCSVData, extractedEntries.length > 0 ? extractedEntries[0].fileName : getOutputFileName())"
            [disabled]="!csvReady">
            <i class="material-icons">file_download</i> Download CSV
          </button>
          <div *ngIf="csvReady" class="text-success mt-2 text-center">
            ✅ CSV is ready to download!
          </div>
      </div>
    </div>

    <!-- Info Text -->
    <div class="row justify-content-center mt-4" *ngIf="!selectedFile">
      <div class="col-md-8 text-center">
        <small class="text-muted">
          Only upload official CIS Benchmark PDF documents. The tool parses structured content based on standard format.
        </small>
          </div>
        </div>
      </div>
    </div>

    <!-- CSV to Database Card -->
    <div class="card mt-4">
      <div class="card-header card-header-info text-center">
        <h4 class="card-title">Save to Database</h4>
        <p class="card-category">Push extracted data into Elasticsearch</p>
      </div>
      <div class="card-body text-center">
        <p class="mb-3 text-muted">
          Once you've downloaded the CSV or verified it, you can push the extracted rules into your Elasticsearch instance.
        </p>

        <button class="btn btn-info btn-lg" (click)="saveToDatabase()" [disabled]="!csvReady">
          <i class="material-icons">save</i> Save to Elasticsearch
        </button>

        <div class="mt-3" *ngIf="saveStatus">
          <span [ngClass]="{
            'text-success': saveStatus === 'success',
            'text-danger': saveStatus === 'error'
          }">
            {{ saveMessage }}
          </span>
        </div>
      </div>
    </div>

    <!-- Extracted files table -->
    <div class="card mt-4">
      <div class="card-header card-header-danger text-center">
        <h4 class="card-title">Extracted Files</h4>
        <p class="card-category">Track extracted files and actions taken</p>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead class="text-primary">
              <tr>
                <th>#</th>
                <th>File Name</th>
                <th>Extraction Time</th>
                <th>CSV Size</th>
                <th>Saved</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of extractedEntries; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ entry.fileName }}</td>
                <td>{{ entry.extractedAt | date:'short' }}</td>
                <td>{{ entry.csv.length }} bytes</td>
                <td>
                  <span class="badge" [ngClass]="entry.saved ? 'badge-success' : 'badge-warning'">
                    {{ entry.saved ? 'Yes' : 'Pending' }}
                  </span>
                </td>
                <td>
                  <!-- Download button -->
                  <button class="btn btn-sm btn-success"
                          (click)="downloadCSV(entry.csv, entry.fileName)">
                    <i class="material-icons">file_download</i> Download
                  </button>
                  <!-- Save button -->
                  <button class="btn btn-sm btn-info" (click)="saveSingleToDatabase(entry)" [disabled]="entry.saved">
                    <i class="material-icons">save</i> Save
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>
